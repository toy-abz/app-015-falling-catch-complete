<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Day15 â€” Falling Catch Game (Complete)</title>
  <meta name="description" content="Day15 è½ã¡ç‰©ã‚­ãƒ£ãƒƒãƒå®Œæˆç‰ˆã€‚ã‚¿ã‚¤ãƒˆãƒ«/ãƒ—ãƒ¬ã‚¤/ãƒªã‚¶ãƒ«ãƒˆã®çŠ¶æ…‹ç®¡ç†ã€ãƒ©ã‚¤ãƒ•åˆ¶ã€çˆ†å¼¾ã€é›£æ˜“åº¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã€LocalStorageãƒ™ã‚¹ãƒˆä¿å­˜ã‚’å­¦ã¹ã‚‹Canvasã‚²ãƒ¼ãƒ ã€‚" />
  <style>
    :root{
      --bg:#050816;
      --panel:#0b1020;
      --card:#0f1631;
      --text:#e8edf7;
      --muted:#9aa3b8;
      --accent:#7aa2ff;
      --accent2:#6efacc;
      --danger:#ff6b6b;
      --warn:#ffd43b;
      --edge:#242c4e;
      --shadow:0 14px 32px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -10%,#172147,transparent),
        var(--bg);
      color:var(--text);
      display:grid;
      place-items:center;
      padding:10px;
    }
    main{
      width:min(96vw,920px);
      background:linear-gradient(180deg,rgba(255,255,255,.03),transparent),var(--panel);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      padding:16px 16px 18px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{
      display:inline-grid;place-items:center;
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--edge);
      background:#10152f;
      font-size:12px;color:var(--muted);
    }
    .chip strong{color:var(--accent2)}
    .chip.good{border-color:rgba(110,250,204,.45);color:#b8ffea}
    .chip.bad{border-color:rgba(255,107,107,.55);color:#ffb3b3}
    .chip.warn{border-color:rgba(255,212,59,.55);color:#fff1ad}

    select,button{
      appearance:none;
      border-radius:12px;
      border:1px solid var(--edge);
      background:#10152f;
      color:var(--text);
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
    }
    button.primary{
      border:0;
      background:linear-gradient(180deg,var(--accent),#5878ff);
      color:#050818;
      font-weight:800;
    }
    button.ghost{
      background:#0d1330;
      border:1px solid #2a3566;
    }
    button:disabled{opacity:.55;cursor:not-allowed;}

    .surface{
      background:var(--card);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      margin-top:12px;
      padding:10px 10px 12px;
    }
    canvas{
      display:block;
      width:100%;
      max-width:880px;
      height:auto;
      border-radius:10px;
      background:linear-gradient(180deg,#182444,#060b18);
      border:1px solid #1f2743;
      touch-action:manipulation;
    }

    footer{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      background:#10152f;
      border:1px solid #27315a;
      border-radius:6px;
      padding:2px 6px;
    }

    /* overlayï¼ˆã‚¿ã‚¤ãƒˆãƒ«/ãƒªã‚¶ãƒ«ãƒˆç”»é¢ï¼‰ */
    .overlay{
      position:relative;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg,rgba(255,255,255,.03),transparent), #0b1020;
      padding:16px;
    }
    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width: 820px){
      .grid2{grid-template-columns:1.2fr .8fr;}
    }
    .panel{
      background:#0f1430;
      border:1px solid #222a52;
      border-radius:14px;
      padding:14px;
    }
    .panel h2{margin:0 0 6px;font-size:16px}
    .panel p{margin:0;color:var(--muted);font-size:13px;line-height:1.55}
    .big{
      font-size:28px;font-weight:900;letter-spacing:.2px;
      font-variant-numeric:tabular-nums;
    }
    .sr{position:absolute;left:-9999px}
    .flash{
      animation: flash .18s ease;
    }
    @keyframes flash{
      from{filter:brightness(1.35)}
      to{filter:brightness(1)}
    }
  </style>
</head>
<body>
<main role="application" aria-labelledby="title">
  <header>
    <div>
      <h1 id="title">Day15 â€” Falling Catch Game (Complete)</h1>
      <div class="muted">ã‚¿ã‚¤ãƒˆãƒ«/ãƒ—ãƒ¬ã‚¤/ãƒªã‚¶ãƒ«ãƒˆã®çŠ¶æ…‹ç®¡ç†ï¼‹ãƒ©ã‚¤ãƒ•åˆ¶ï¼‹çˆ†å¼¾ï¼‹ãƒ™ã‚¹ãƒˆä¿å­˜ï¼ˆSpaceã§Start/Retryï¼‰</div>
      <div class="row" style="margin-top:6px" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
        <span class="chip">ã‚¹ã‚³ã‚¢ï¼š<strong id="score">0</strong></span>
        <span class="chip">æ®‹ã‚Šï¼š<strong id="time">30.0</strong>s</span>
        <span class="chip warn">ãƒ©ã‚¤ãƒ•ï¼š<strong id="life">3</strong></span>
        <span class="chip good">ãƒ™ã‚¹ãƒˆï¼š<strong id="best">0</strong></span>
        <span id="feedback" class="chip" aria-live="polite"></span>
      </div>
    </div>

    <div class="row" aria-label="è¨­å®š">
      <label class="muted">
        é›£æ˜“åº¦
        <select id="mode">
          <option value="easy">Easy</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Hard</option>
        </select>
      </label>
      <button id="startBtn" class="primary">Start</button>
      <button id="retryBtn" class="ghost">Retry</button>
    </div>
  </header>

  <section class="surface">
    <canvas id="game" width="800" height="480" aria-label="ã‚²ãƒ¼ãƒ ç”»é¢"></canvas>

    <!-- ã‚¿ã‚¤ãƒˆãƒ«/ãƒªã‚¶ãƒ«ãƒˆç”¨ã®UIï¼ˆCanvasã®ä¸‹ã«è¡¨ç¤ºï¼‰ -->
    <div id="overlay" class="overlay" aria-live="polite"></div>
  </section>

  <footer>
    <div>
      æ“ä½œï¼š<span class="kbd">â†</span><span class="kbd">â†’</span> / ã‚¿ãƒƒãƒ—ã§ç§»å‹•ï½œ
      <span class="kbd">Space</span> Start/Retryï½œ
      <span class="kbd">R</span> Retry
    </div>
    <div>Â© toy-abz â€” 100æ—¥ãƒãƒ£ãƒ¬ãƒ³ã‚¸ Day15</div>
  </footer>

  <div id="live" class="sr" aria-live="assertive"></div>
</main>

<script>
/* ============================================================================
  Day15 â€” Falling Catch Game (Complete)
  å­¦ç¿’ãƒ†ãƒ¼ãƒï¼ˆDay14â†’Day15ã®ç™ºå±•ï¼‰ï¼š
    1) ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ï¼ˆtitle / playing / resultï¼‰
    2) ãƒ©ã‚¤ãƒ•åˆ¶ï¼ˆãƒŸã‚¹ã§ -1ã€0ã§çµ‚äº†ï¼‰
    3) ã‚¢ã‚¤ãƒ†ãƒ ç¨®é¡ï¼ˆgood / bombï¼‰ã§ãƒ«ãƒ¼ãƒ«åˆ†å²
    4) é›£æ˜“åº¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆæ™‚é–“çµŒéã§å°‘ã—ãšã¤é›£ã—ãï¼‰
    5) LocalStorage ã§ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰

  å®Ÿè£…ãƒãƒªã‚·ãƒ¼ï¼š
    - å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã—ï¼ˆVanilla JSï¼‰
    - å˜ä¸€HTMLã§GitHub Pagesã«ãã®ã¾ã¾å…¬é–‹ã§ãã‚‹
============================================================================ */

/* ------------------------------
   DOMå–å¾—
-------------------------------- */
const canvas   = document.getElementById('game');
const ctx      = canvas.getContext('2d');

const scoreEl  = document.getElementById('score');
const timeEl   = document.getElementById('time');
const lifeEl   = document.getElementById('life');
const bestEl   = document.getElementById('best');
const feedback = document.getElementById('feedback');
const overlay  = document.getElementById('overlay');
const live     = document.getElementById('live');

const modeSel  = document.getElementById('mode');
const startBtn = document.getElementById('startBtn');
const retryBtn = document.getElementById('retryBtn');

/* ------------------------------
   å®šæ•°ãƒ»è¨­å®š
-------------------------------- */
const GAME_MS = 30_000;          // åˆ¶é™æ™‚é–“ï¼ˆ30ç§’ï¼‰
const START_LIFE = 3;            // åˆæœŸãƒ©ã‚¤ãƒ•
const BEST_KEY = 'fallingcatch-best-v2'; // LocalStorageã‚­ãƒ¼ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼‰

// é›£æ˜“åº¦ã”ã¨ã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆDay14ã‚ˆã‚Šå°‘ã—ã‚²ãƒ¼ãƒ ã£ã½ãï¼‰
const MODES = {
  easy:   { spawnEvery: 780, speed: [120, 180], concurrent: 3 },
  normal: { spawnEvery: 600, speed: [170, 240], concurrent: 4 },
  hard:   { spawnEvery: 430, speed: [230, 320], concurrent: 5 },
};

// ã‚¢ã‚¤ãƒ†ãƒ ã®å‡ºç¾æ¯”ç‡ï¼ˆbombã‚’å°‘ãªã‚ã«ï¼‰
const BOMB_RATE = 0.15; // 15%

/* ------------------------------
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
-------------------------------- */
const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
const rand  = (min, max) => min + Math.random() * (max - min);

// 0..1ã‚’ä½¿ã£ã¦ã€Œã ã‚“ã ã‚“é›£ã—ãã™ã‚‹ã€ä¿‚æ•°ã‚’ä½œã‚‹ï¼ˆ0=é–‹å§‹ç›´å¾Œ / 1=çµ‚äº†ç›´å‰ï¼‰
function progress01(){
  return 1 - (state.timeLeftMs / GAME_MS); // æ®‹ã‚Šæ™‚é–“ã‹ã‚‰é€†ç®—
}

// LocalStorage èª­ã¿è¾¼ã¿
function loadBest(){
  try { return JSON.parse(localStorage.getItem(BEST_KEY) || '{}'); }
  catch { return {}; }
}

// LocalStorage ä¿å­˜
function saveBest(best){
  try { localStorage.setItem(BEST_KEY, JSON.stringify(best)); }
  catch { /* private modeç­‰ã§å¤±æ•—ã—ã¦ã‚‚ã‚²ãƒ¼ãƒ ã¯ç¶šã‘ã‚‹ */ }
}

/* ------------------------------
   çŠ¶æ…‹ï¼ˆStateï¼‰
-------------------------------- */
const state = {
  scene: 'title',     // 'title' | 'playing' | 'result'
  mode: 'normal',
  timeLeftMs: GAME_MS,
  score: 0,
  life: START_LIFE,
  best: loadBest(),   // { easy: number, normal: number, hard: number }
  lastT: 0,           // ç›´å‰ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚åˆ»
  spawnAcc: 0,        // ç”Ÿæˆé–“éš”è¨ˆæ¸¬ç”¨ã®è“„ç©æ™‚é–“
  items: [],          // è½ä¸‹ç‰©é…åˆ—
  player: null,       // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  msgTtlMs: 0,        // HUDãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚é–“
};

/* ------------------------------
   ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
-------------------------------- */
function initPlayer(){
  const w = 90;
  const h = 16;
  state.player = {
    w, h,
    x: (canvas.width - w) / 2,
    y: canvas.height - h - 12,
    speed: 460,   // px/s
    dir: 0        // -1 left / 0 stop / 1 right
  };
}

/* ------------------------------
   ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆè½ä¸‹ç‰©ï¼‰
--------------------------------
  type:
    - 'good' : ã‚­ãƒ£ãƒƒãƒ +1
    - 'bomb' : ã‚­ãƒ£ãƒƒãƒã§ãƒ©ã‚¤ãƒ• -1ï¼ˆé¿ã‘ã‚‹ã¹ãï¼‰
-------------------------------- */
function spawnItem(){
  const conf = MODES[state.mode];

  // é€²è¡Œåº¦ã«å¿œã˜ã¦é›£åŒ–ï¼ˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
  const p = progress01(); // 0..1
  const spawnScale = 1 - 0.12 * p; // æœ€å¤§12%ã ã‘é–“éš”çŸ­ç¸®
  const speedScale = 1 + 0.28 * p; // æœ€å¤§28%ã ã‘é€Ÿåº¦å¢—åŠ 

  const w = rand(30, 54);
  const h = rand(18, 30);
  const x = rand(0, canvas.width - w);
  const y = -h - 12;

  const baseVy = rand(conf.speed[0], conf.speed[1]);
  const vy = baseVy * speedScale;

  const isBomb = Math.random() < BOMB_RATE;
  const type = isBomb ? 'bomb' : 'good';

  // è‰²ï¼ˆè¦‹ãŸç›®ã§åŒºåˆ¥ã§ãã‚‹ã‚ˆã†ã«ï¼‰
  const color = (type === 'bomb') ? '#ff6b6b' : '#6efacc';

  state.items.push({
    x, y, w, h, vy, type, color,
    caught:false,
    dead:false,
  });
}

/* ------------------------------
   è¡çªåˆ¤å®šï¼ˆAABB: çŸ©å½¢åŒå£«ï¼‰
-------------------------------- */
function hitRect(a, b){
  return (
    a.x < b.x + b.w &&
    a.x + a.w > b.x &&
    a.y < b.y + b.h &&
    a.y + a.h > b.y
  );
}

/* ------------------------------
   æç”»ï¼ˆCanvasï¼‰
-------------------------------- */
function drawBackground(){
  const grd = ctx.createLinearGradient(0,0,0,canvas.height);
  grd.addColorStop(0,'#182746');
  grd.addColorStop(1,'#050815');
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // ã†ã£ã™ã‚‰ç¸¦ç·šï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿï¼‰
  ctx.globalAlpha = 0.08;
  ctx.strokeStyle = '#cfe0ff';
  for(let x=0; x<=canvas.width; x+=50){
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,canvas.height);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // åœ°é¢ãƒ©ã‚¤ãƒ³
  const p = state.player;
  const groundY = p.y + p.h + 4;
  ctx.strokeStyle = '#273253';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, groundY);
  ctx.lineTo(canvas.width, groundY);
  ctx.stroke();
}

function drawPlayer(){
  const p = state.player;
  // æœ¬ä½“
  ctx.fillStyle = '#7aa2ff';
  roundRect(p.x, p.y, p.w, p.h, 7, true);

  // ç›®å°
  ctx.fillStyle = '#b7c8ff';
  ctx.fillRect(p.x + p.w*0.3, p.y - 4, p.w*0.4, 4);
}

function drawItems(){
  for(const it of state.items){
    ctx.fillStyle = it.color;
    roundRect(it.x, it.y, it.w, it.h, 7, true);

    // bombã¯ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ ï¼ˆè¦–èªæ€§UPï¼‰
    if(it.type === 'bomb'){
      ctx.fillStyle = '#23050a';
      ctx.font = 'bold 14px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('!', it.x + it.w/2, it.y + it.h/2 + 0.5);
    }
  }
}

function draw(){
  drawBackground();
  drawPlayer();
  drawItems();
}

/* Canvasè§’ä¸¸çŸ©å½¢ */
function roundRect(x,y,w,h,r,fill){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y,   x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x,   y+h, rr);
  ctx.arcTo(x,   y+h, x,   y,   rr);
  ctx.arcTo(x,   y,   x+w, y,   rr);
  if(fill) ctx.fill();
  else ctx.stroke();
}

/* ------------------------------
   HUDæ›´æ–°
-------------------------------- */
function updateHud(){
  scoreEl.textContent = String(state.score);
  lifeEl.textContent  = String(state.life);
  timeEl.textContent  = (state.timeLeftMs / 1000).toFixed(1);
  bestEl.textContent  = String(state.best[state.mode] || 0);
}

/* HUDãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçŸ­æ™‚é–“è¡¨ç¤ºï¼‰ */
function showMsg(text, kind=''){
  feedback.textContent = text;
  feedback.className = 'chip' + (kind ? ` ${kind}` : '');
  state.msgTtlMs = 450; // 0.45ç§’è¡¨ç¤º
}

/* ------------------------------
   Overlayï¼ˆtitle/result UIï¼‰
-------------------------------- */
function renderOverlay(){
  // ã‚·ãƒ¼ãƒ³ã«å¿œã˜ã¦HTMLã‚’å·®ã—æ›¿ãˆã‚‹ï¼ˆCanvasã®å¤–ã«ã‚ã‚‹UIï¼‰
  if(state.scene === 'title'){
    overlay.innerHTML = `
      <div class="grid2">
        <div class="panel">
          <h2>ğŸ¯ ãƒ«ãƒ¼ãƒ«</h2>
          <p>
            è½ã¡ã¦ãã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç¨¼ãã¾ã™ã€‚<br>
            <span class="chip good" style="display:inline-block;margin-top:8px">GOODï¼š+1</span>
            <span class="chip bad" style="display:inline-block;margin-top:8px">BOMBï¼šã‚­ãƒ£ãƒƒãƒã§ãƒ©ã‚¤ãƒ• -1ï¼ˆé¿ã‘ã‚ˆã†ï¼‰</span><br><br>
            åˆ¶é™æ™‚é–“ã¯ <b>30ç§’</b>ã€‚ãƒ©ã‚¤ãƒ•ãŒ <b>0</b> ã«ãªã£ã¦ã‚‚çµ‚äº†ã§ã™ã€‚
          </p>
        </div>
        <div class="panel">
          <h2>ğŸ§  å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</h2>
          <p>
            ãƒ»ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ï¼ˆtitle / playing / resultï¼‰<br>
            ãƒ»è¡çªåˆ¤å®šï¼ˆAABBï¼‰ã¨é…åˆ—ç®¡ç†<br>
            ãƒ»é›£æ˜“åº¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆæ™‚é–“ã§é›£åŒ–ï¼‰<br>
            ãƒ»LocalStorageã§ãƒ™ã‚¹ãƒˆä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰<br><br>
            <span class="muted">æ“ä½œï¼šâ† â†’ / ã‚¿ãƒƒãƒ—ç§»å‹•ã€Spaceã§Start</span>
          </p>
        </div>
      </div>
    `;
  } else if(state.scene === 'result'){
    const best = state.best[state.mode] || 0;
    const isNew = state.score >= best && state.score !== 0; // endGameã§æ›´æ–°æ¸ˆã¿
    overlay.innerHTML = `
      <div class="grid2">
        <div class="panel">
          <h2>ğŸ çµæœ</h2>
          <div class="big">${state.score} <span class="muted">pt</span></div>
          <p style="margin-top:6px">
            é›£æ˜“åº¦ï¼š<b>${state.mode.toUpperCase()}</b><br>
            ãƒ™ã‚¹ãƒˆï¼š<b>${best}</b> ${isNew ? '<span class="chip good" style="margin-left:6px">NEW!</span>' : ''}
          </p>
          <p style="margin-top:10px" class="muted">
            Space / R ã§ãƒªãƒˆãƒ©ã‚¤ã§ãã¾ã™ã€‚
          </p>
        </div>
        <div class="panel">
          <h2>æ¬¡ã®ä¸€æ‰‹</h2>
          <p>
            ãƒ»çˆ†å¼¾ã®ç¨®é¡ã‚’å¢—ã‚„ã™ï¼ˆ-2ç‚¹ã€ã‚¹ãƒ­ãƒ¼åŠ¹æœãªã©ï¼‰<br>
            ãƒ»ãƒ¬ãƒ™ãƒ«åˆ¶ï¼ˆä¸€å®šã‚¹ã‚³ã‚¢ã§ã‚¹ãƒ”ãƒ¼ãƒ‰UPï¼‰<br>
            ãƒ»ã‚¹ãƒãƒ›æ“ä½œã‚’ãƒ‰ãƒ©ãƒƒã‚°è¿½å¾“ã«å¤‰æ›´<br>
            ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè¤‡æ•°è¨˜éŒ²ï¼‰ã¸æ‹¡å¼µ
          </p>
        </div>
      </div>
    `;
  } else {
    // playing ã®ã¨ãã¯ overlay ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ï¼ˆç©ºã§ã‚‚OKï¼‰
    overlay.innerHTML = `
      <div class="muted">ãƒ—ãƒ¬ã‚¤ä¸­ï¼šGOODã¯å–ã‚‹ï¼BOMBã¯é¿ã‘ã‚‹ã€‚ãƒ™ã‚¹ãƒˆæ›´æ–°ã‚’ç‹™ãŠã†ï¼</div>
    `;
  }
}

/* ------------------------------
   ã‚²ãƒ¼ãƒ é–‹å§‹ / çµ‚äº† / ãƒªã‚»ãƒƒãƒˆ
-------------------------------- */
function setScene(next){
  state.scene = next;
  renderOverlay();
}

function resetGame(){
  state.timeLeftMs = GAME_MS;
  state.score = 0;
  state.life = START_LIFE;
  state.spawnAcc = 0;
  state.items = [];
  state.msgTtlMs = 0;
  initPlayer();
  updateHud();
  draw();
}

function startGame(){
  state.mode = modeSel.value;
  updateHud();
  resetGame();
  setScene('playing');

  showMsg('Start!', '');
  state.lastT = performance.now();
  requestAnimationFrame(loop);
}

function endGame(){
  // ã‚·ãƒ¼ãƒ³é·ç§»ï¼šresult
  setScene('result');

  // ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  const prev = state.best[state.mode] || 0;
  if(state.score > prev){
    state.best[state.mode] = state.score;
    saveBest(state.best);
    showMsg(`çµ‚äº†ï¼ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼š${state.score}pt`, 'good');
  }else{
    showMsg(`çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ï¼š${state.score}pt`, '');
  }

  updateHud();
  live.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚ã‚¹ã‚³ã‚¢ ${state.score} ç‚¹`;
}

/* ------------------------------
   ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆrequestAnimationFrameï¼‰
--------------------------------
  ãƒã‚¤ãƒ³ãƒˆï¼šdtï¼ˆå‰ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã®å·®ï¼‰ã‚’ä½¿ã†ã¨
  PC/ã‚¹ãƒãƒ›ã‚„å‡¦ç†è² è·ã«ã‚ˆã£ã¦FPSãŒå¤‰ã‚ã£ã¦ã‚‚é€Ÿåº¦ãŒå®‰å®šã™ã‚‹
-------------------------------- */
function loop(now){
  if(state.scene !== 'playing') return;

  const dt = now - state.lastT;
  state.lastT = now;

  // 1) ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
  const p = state.player;
  if(p.dir !== 0){
    p.x += p.dir * p.speed * (dt/1000);
    p.x = clamp(p.x, 0, canvas.width - p.w);
  }

  // 2) è½ä¸‹ç‰©ã®ç”Ÿæˆ
  const conf = MODES[state.mode];

  // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸç”Ÿæˆé–“éš”ï¼ˆspawnEveryã‚’å°‘ã—çŸ­ç¸®ï¼‰
  const t = progress01();                 // 0..1
  const spawnEvery = conf.spawnEvery * (1 - 0.12 * t);

  state.spawnAcc += dt;
  if(state.spawnAcc >= spawnEvery && state.items.length < conf.concurrent){
    spawnItem();
    state.spawnAcc = 0;
  }

  // 3) è½ä¸‹ç‰©ã®æ›´æ–°ï¼ˆè½ã¡ã‚‹ï¼‰ï¼‹è¡çªåˆ¤å®š
  const groundY = p.y + p.h + 4;
  for(const it of state.items){
    it.y += it.vy * (dt/1000);

    // ã‚­ãƒ£ãƒƒãƒåˆ¤å®šï¼ˆçŸ©å½¢åŒå£«ï¼‰
    if(!it.caught && hitRect(it, p)){
      it.caught = true;

      if(it.type === 'good'){
        state.score += 1;
        showMsg('+1', 'good');
      }else{
        // bombã‚’ã‚­ãƒ£ãƒƒãƒã—ãŸã‚‰ãƒ©ã‚¤ãƒ•-1ï¼ˆé¿ã‘ã‚‹ã¹ãï¼‰
        state.life -= 1;
        showMsg('BOMB! -1 LIFE', 'bad');

        // ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆæ¼”å‡ºï¼‰
        canvas.classList.remove('flash'); // å†ç™ºç«ç”¨
        void canvas.offsetWidth;          // reflow
        canvas.classList.add('flash');
      }
    }

    // åœ°é¢ã«åˆ°é”ã—ãŸã‚‰ã€ŒãƒŸã‚¹ã€
    if(!it.dead && it.y + it.h >= groundY){
      it.dead = true;

      // good ã‚’è½ã¨ã—ãŸã‚‰ãƒ©ã‚¤ãƒ•-1ï¼ˆç·Šå¼µæ„Ÿï¼‰
      // bomb ã‚’è½ã¨ã™ã®ã¯ãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—ï¼ˆé¿ã‘ã‚‹ã‚²ãƒ¼ãƒ æ€§ï¼‰
      if(it.type === 'good' && !it.caught){
        state.life -= 1;
        showMsg('MISS -1 LIFE', 'warn');
      }
    }
  }

  // 4) ä¸è¦ãªè½ä¸‹ç‰©ã‚’é™¤å»ï¼ˆé…åˆ—ã‚’è»½ãä¿ã¤ï¼‰
  state.items = state.items.filter(it => !it.caught && !it.dead);

  // 5) ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
  state.timeLeftMs = Math.max(0, state.timeLeftMs - dt);

  // 6) çµ‚äº†åˆ¤å®š
  if(state.life <= 0 || state.timeLeftMs <= 0){
    endGame();
    return;
  }

  // 7) HUDè¡¨ç¤ºæ™‚é–“ã®æ¸›è¡°
  if(state.msgTtlMs > 0){
    state.msgTtlMs = Math.max(0, state.msgTtlMs - dt);
    if(state.msgTtlMs === 0){
      feedback.textContent = '';
      feedback.className = 'chip';
    }
  }

  // 8) æç”» & HUDæ›´æ–°
  updateHud();
  draw();

  requestAnimationFrame(loop);
}

/* ------------------------------
   å…¥åŠ›ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰
-------------------------------- */
window.addEventListener('keydown', (e)=>{
  if(!state.player) return;

  if(e.key === 'ArrowLeft')  state.player.dir = -1;
  if(e.key === 'ArrowRight') state.player.dir = 1;

  // Spaceï¼štitle/resultã§ Start/Retry
  if(e.code === 'Space'){
    e.preventDefault();
    if(state.scene === 'title') startGame();
    else if(state.scene === 'result') startGame();
  }

  // Rï¼šresultã§Retry
  if(e.key.toLowerCase() === 'r'){
    if(state.scene === 'result') startGame();
  }
});

window.addEventListener('keyup', (e)=>{
  if(!state.player) return;

  if(e.key === 'ArrowLeft' && state.player.dir === -1) state.player.dir = 0;
  if(e.key === 'ArrowRight' && state.player.dir === 1) state.player.dir = 0;
});

/* ------------------------------
   å…¥åŠ›ï¼ˆãƒã‚¤ãƒ³ã‚¿ï¼‰â€»ã‚¹ãƒãƒ›æƒ³å®š
--------------------------------
  ã‚¿ãƒƒãƒ—ä½ç½®ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸­å¿ƒã‚’åˆã‚ã›ã‚‹ç°¡æ˜“æ“ä½œ
-------------------------------- */
canvas.addEventListener('pointerdown', (e)=>{
  if(!state.player) return;
  if(state.scene !== 'playing') return;

  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const x = (e.clientX - rect.left) * scaleX;

  state.player.x = clamp(x - state.player.w/2, 0, canvas.width - state.player.w);
});

/* ------------------------------
   UIã‚¤ãƒ™ãƒ³ãƒˆ
-------------------------------- */
startBtn.addEventListener('click', ()=>{
  if(state.scene === 'playing') return;
  startGame();
});

retryBtn.addEventListener('click', ()=>{
  startGame();
});

modeSel.addEventListener('change', ()=>{
  // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã¯ãƒ™ã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚·ãƒ¼ãƒ³ã«é–¢ä¿‚ãªãï¼‰
  state.mode = modeSel.value;
  updateHud();
});

/* ------------------------------
   åˆæœŸåŒ–
-------------------------------- */
(function init(){
  initPlayer();
  updateHud();
  setScene('title');
  draw();
})();
</script>
</body>
</html>
